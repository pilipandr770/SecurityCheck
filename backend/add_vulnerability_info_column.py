"""
Миграция: Добавить поле vulnerability_info в scan_results
"""

from flask import Flask
from database import init_db, db
from sqlalchemy import text
import os
from dotenv import load_dotenv

# Загружаем переменные окружения
load_dotenv()

# Создаем Flask приложение
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Инициализируем БД
init_db(app)

def add_vulnerability_info_column():
    """Добавить JSON поле для хранения информации из базы знаний"""
    
    with app.app_context():
        try:
            # Проверяем существует ли колонка
            check_query = text("""
                SELECT column_name 
                FROM information_schema.columns 
                WHERE table_schema = 'security_check_schema'
                AND table_name = 'scan_results'
                AND column_name = 'vulnerability_info'
            """)
            
            result = db.session.execute(check_query).fetchone()
            
            if result:
                print("⚠️ Поле vulnerability_info уже существует")
                return
            
            print("Добавление поля vulnerability_info...")
            
            # Добавляем колонку
            db.session.execute(text("""
                ALTER TABLE security_check_schema.scan_results 
                ADD COLUMN vulnerability_info JSONB
            """))
            
            db.session.commit()
            print("✅ Добавлено поле vulnerability_info")
            
            print("\n✅ Миграция завершена!")
            
        except Exception as e:
            print(f"❌ Ошибка миграции: {e}")
            db.session.rollback()
            raise

if __name__ == '__main__':
    add_vulnerability_info_column()
