{% extends "base.html" %}

{% block title %}Tarife - SecurityCheck{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 mb-3">Wählen Sie den passenden Tarif</h1>
        <p class="lead text-muted">
            Überprüfen Sie die Sicherheit Ihrer Websites и получайте рекомендации по защите.<br>
            <strong>Ziel:</strong> Helfen Sie, Schwachstellen zu finden и предложить защищенную разработку.
        </p>
        
        <!-- Переключатель период оплаты -->
        <div class="btn-group mt-4" role="group">
            <input type="radio" class="btn-check" name="billingPeriod" id="monthly" checked>
            <label class="btn btn-outline-primary" for="monthly">Monatlich</label>
            
            <input type="radio" class="btn-check" name="billingPeriod" id="yearly">
            <label class="btn btn-outline-primary" for="yearly">
                Jährlich 
                <span class="badge bg-success ms-1">17% Rabatt</span>
            </label>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Free план -->
        <div class="col-lg-4">
            <div class="card shadow-lg h-100 {% if current_user.subscription_plan.value == 'free' %}border-primary{% endif %}">
                {% if current_user.subscription_plan.value == 'free' %}
                <div class="card-header bg-primary text-white text-center">
                    <strong><i class="fas fa-check-circle"></i> Aktueller Plan</strong>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h3 class="card-title text-center">Free</h3>
                    <div class="text-center mb-4">
                        <h1 class="display-3 fw-bold">€0</h1>
                        <p class="text-muted">Für immer kostenlos</p>
                    </div>
                    
                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>10</strong> Website-Scans pro Monat
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>50</strong> Link-Checks pro Monat
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>5</strong> WiFi-Scans pro Monat
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>5</strong> Domain-Prüfungen pro Monat
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Basis-Sicherheitsbericht
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Scan-Verlauf (7 Tage)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-times text-danger me-2"></i>
                            PDF-Export von Berichten
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-times text-danger me-2"></i>
                            E-Mail-Benachrichtigungen
                        </li>
                    </ul>
                    
                    <div class="mt-auto">
                        {% if current_user.subscription_plan.value == 'free' %}
                        <button class="btn btn-secondary btn-lg w-100" disabled>
                            Aktueller Plan
                        </button>
                        {% else %}
                        <button class="btn btn-outline-primary btn-lg w-100" onclick="downgradeToFree()">
                            Zu Free wechseln
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Starter план -->
        <div class="col-lg-4">
            <div class="card shadow-lg h-100 border-warning {% if current_user.subscription_plan.value == 'starter' %}border-3{% endif %}">
                {% if current_user.subscription_plan.value == 'starter' %}
                <div class="card-header bg-warning text-dark text-center">
                    <strong><i class="fas fa-check-circle"></i> Aktueller Plan</strong>
                </div>
                {% else %}
                <div class="card-header bg-warning text-dark text-center">
                    <strong><i class="fas fa-star"></i> Beliebt</strong>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h3 class="card-title text-center">Starter</h3>
                    <div class="text-center mb-4">
                        <h1 class="display-3 fw-bold">
                            <span class="monthly-price">€9.99</span>
                            <span class="yearly-price" style="display: none;">€99</span>
                        </h1>
                        <p class="text-muted">
                            <span class="monthly-price">pro Monat</span>
                            <span class="yearly-price" style="display: none;">pro Jahr</span>
                        </p>
                    </div>
                    
                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>∞ Unbegrenzt</strong> проверки сайтов
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>∞ Unbegrenzt</strong> проверки ссылок
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>∞ Unbegrenzt</strong> WiFi-сканы
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Erweiterter Bericht mit Empfehlungen
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Scan-Verlauf (90 Tage)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            E-Mail-Benachrichtigungen bei Bedrohungen
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            PDF-Export von Berichten
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-times text-danger me-2"></i>
                            API-Zugriff
                        </li>
                    </ul>
                            <strong>50</strong> сканирований сайтов/день
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>100</strong> проверок ссылок/день
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>50</strong> анализов файлов/день
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>100</strong> проверок доменов/день
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Максимум файла: <strong>50 MB</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>KI-Erklärungen</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>API-Zugriff</strong> (100 запросов/час)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            E-Mail поддержка
                        </li>
                    </ul>
                    
                    <div class="mt-auto">
                        {% if current_user.subscription_plan.value == 'starter' %}
                        <button class="btn btn-warning btn-lg w-100" disabled>
                            Aktueller Plan
                        </button>
                        {% else %}
                        <button class="btn btn-warning btn-lg w-100" onclick="upgradeToPlan('starter')">
                            {% if current_user.subscription_plan.value == 'free' %}
                            Zu Starter wechseln
                            {% else %}
                            Zu Starter downgraden
                            {% endif %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pro план -->
        <div class="col-lg-4">
            <div class="card shadow-lg h-100 border-success {% if current_user.subscription_plan.value == 'pro' %}border-3{% endif %}">
                {% if current_user.subscription_plan.value == 'pro' %}
                <div class="card-header bg-success text-white text-center">
                    <strong><i class="fas fa-check-circle"></i> Aktueller Plan</strong>
                </div>
                {% else %}
                <div class="card-header bg-success text-white text-center">
                    <strong><i class="fas fa-crown"></i> Beste Wahl für Unternehmen</strong>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h3 class="card-title text-center">Pro + Development</h3>
                    <div class="text-center mb-4">
                        <h1 class="display-3 fw-bold">
                            <span class="monthly-price">€29.99</span>
                            <span class="yearly-price" style="display: none;">€299</span>
                        </h1>
                        <p class="text-muted">
                            <span class="monthly-price">pro Monat</span>
                            <span class="yearly-price" style="display: none;">pro Jahr</span>
                        </p>
                    </div>
                    
                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Alles aus dem Starter-Plan</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Unbegrenzter Scan-Verlauf
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            API-Zugriff für Integrationen
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            White-Label-Berichte
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Experten-Beratung (1 Stunde/Monat)</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Sicherheitsarchitektur-Analyse</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Schutzempfehlungen</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Prioritäts-Support 24/7
                        </li>
                    </ul>
                            <strong>Priorität AI</strong> объяснений
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>API-Zugriff</strong> (безлимит)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Prioritäts-Support</strong> 24/7
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Webhook</strong> уведомления
                        </li>
                    </ul>
                    
                    <div class="mt-auto">
                        {% if current_user.subscription_plan.value == 'pro' %}
                        <button class="btn btn-success btn-lg w-100" disabled>
                            Aktueller Plan
                        </button>
                        {% else %}
                        <button class="btn btn-success btn-lg w-100" onclick="upgradeToPlan('pro')">
                            Zu Pro upgraden
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Сравнение функций -->
    <div class="card shadow-lg mt-5">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">Tarif-Vergleich</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Funktion</th>
                            <th class="text-center">Free</th>
                            <th class="text-center">Starter</th>
                            <th class="text-center">Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Website-Scans</td>
                            <td class="text-center">5/день</td>
                            <td class="text-center">50/день</td>
                            <td class="text-center"><strong>Безлимит</strong></td>
                        </tr>
                        <tr>
                            <td>Link-Checks</td>
                            <td class="text-center">10/день</td>
                            <td class="text-center">100/день</td>
                            <td class="text-center"><strong>Безлимит</strong></td>
                        </tr>
                        <tr>
                            <td>Datei-Analyse</td>
                            <td class="text-center">5/день</td>
                            <td class="text-center">50/день</td>
                            <td class="text-center"><strong>Безлимит</strong></td>
                        </tr>
                        <tr>
                            <td>Domain-Prüfungen</td>
                            <td class="text-center">10/день</td>
                            <td class="text-center">100/день</td>
                            <td class="text-center"><strong>Безлимит</strong></td>
                        </tr>
                        <tr>
                            <td>Maximale Dateigröße</td>
                            <td class="text-center">10 MB</td>
                            <td class="text-center">50 MB</td>
                            <td class="text-center"><strong>500 MB</strong></td>
                        </tr>
                        <tr>
                            <td>KI-Erklärungen</td>
                            <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                            <td class="text-center"><i class="fas fa-check text-success"></i> Priorität</td>
                        </tr>
                        <tr>
                            <td>API-Zugriff</td>
                            <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                            <td class="text-center">100 запросов/час</td>
                            <td class="text-center"><strong>Безлимит</strong></td>
                        </tr>
                        <tr>
                            <td>Support</td>
                            <td class="text-center">Forum</td>
                            <td class="text-center">E-Mail</td>
                            <td class="text-center"><strong>24/7 Priority</strong></td>
                        </tr>
                        <tr>
                            <td>Webhooks</td>
                            <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                            <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- FAQ -->
    <div class="card shadow-lg mt-5 mb-5">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">Häufig gestellte Fragen</h4>
        </div>
        <div class="card-body">
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq1">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">
                            Kann ich das Abonnement kündigen?
                        </button>
                    </h2>
                    <div id="collapse1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Ja, Sie können das Abonnement jederzeit kündigen. Nach der Kündigung behalten Sie den Zugriff bis zum Ende des bezahlten Zeitraums.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq2">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">
                            Welche Zahlungsmethoden werden akzeptiert?
                        </button>
                    </h2>
                    <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Wir akzeptieren alle gängigen Kreditkarten über das sichere Zahlungsgateway Stripe.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq3">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3">
                            Kann ich den Plan ändern?
                        </button>
                    </h2>
                    <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Ja, Sie können Ihren Plan jederzeit upgraden oder downgraden. Bei einem Upgrade erfolgt eine anteilige Abrechnung.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq4">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4">
                            Gibt es eine Geld-zurück-Garantie?
                        </button>
                    </h2>
                    <div id="collapse4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Ja, wir bieten eine 14-tägige Geld-zurück-Garantie средств ohne Fragen.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Переключение период оплаты
const monthlyRadio = document.getElementById('monthly');
const yearlyRadio = document.getElementById('yearly');

monthlyRadio.addEventListener('change', () => {
    document.querySelectorAll('.monthly-price').forEach(el => el.style.display = 'inline');
    document.querySelectorAll('.yearly-price').forEach(el => el.style.display = 'none');
});

yearlyRadio.addEventListener('change', () => {
    document.querySelectorAll('.monthly-price').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.yearly-price').forEach(el => el.style.display = 'inline');
});

async function upgradeToPlan(plan) {
    const billingPeriod = yearlyRadio.checked ? 'yearly' : 'monthly';
    
    if (!confirm(`Zum Plan ${plan.toUpperCase()} wechseln (${billingPeriod === 'yearly' ? 'jährliche' : 'monatliche'} Zahlung)?`)) {
        return;
    }
    
    try {
        const result = await SecurityCheckAPI.upgradeSubscription(plan, billingPeriod);
        
        if (result.checkout_url) {
            // Перенаправить на Stripe Checkout
            window.location.href = result.checkout_url;
        } else {
            SecurityCheck.showNotification('План изменён', 'success');
            setTimeout(() => window.location.reload(), 1500);
        }
        
    } catch (error) {
        SecurityCheck.showNotification('Fehler: ' + error.message, 'danger');
    }
}

async function downgradeToFree() {
    if (!confirm('Zum Free-Plan downgraden? Sie verlieren den Zugang zu Premium-Funktionen.')) {
        return;
    }
    
    try {
        await SecurityCheckAPI.cancelSubscription();
        SecurityCheck.showNotification('План изменён на Free', 'success');
        setTimeout(() => window.location.reload(), 1500);
        
    } catch (error) {
        SecurityCheck.showNotification('Fehler: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
