{% extends "base.html" %}

{% block title %}Link-Checks - SecurityCheck{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-lg">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="fas fa-link"></i> Sicherheitspr√ºfung —Å—Å—ã–ª–æ–∫
                </h3>
            </div>
            <div class="card-body">
                <p class="lead">
                    Link-Checks –Ω–∞ —Ñ–∏—à–∏–Ω–≥, –≤–∏—Ä—É—Å—ã –∏ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç. 
                    –ò—Å–ø–æ–ª—å–∑—É–µ–º VirusTotal, Google Safe Browsing –∏ URLhaus.
                </p>
                
                <!-- –§–æ—Ä–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                <form id="checkForm" class="mb-4">
                    <div class="mb-3">
                        <label for="urlInput" class="form-label">URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-link"></i>
                            </span>
                            <input type="url" 
                                   class="form-control" 
                                   id="urlInput" 
                                   name="url"
                                   placeholder="https://suspicious-link.com"
                                   required>
                            <button type="submit" class="btn btn-success" id="checkBtn">
                                <i class="fas fa-shield-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                            </button>
                        </div>
                        <div class="form-text">
                            –í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </div>
                    </div>
                </form>
                
                <!-- –õ–∏–º–∏—Ç—ã -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>–í–∞—à –ª–∏–º–∏—Ç:</strong> 
                    {% if current_user.subscription_plan.value == 'free' %}
                        20 –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –¥–µ–Ω—å (–æ—Å—Ç–∞–ª–æ—Å—å: {{ limits.link_checks_remaining }})
                    {% elif current_user.subscription_plan.value == 'starter' %}
                        200 –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –¥–µ–Ω—å (–æ—Å—Ç–∞–ª–æ—Å—å: {{ limits.link_checks_remaining }})
                    {% else %}
                        Unbegrenzt –ø—Ä–æ–≤–µ—Ä–∫–∏
                    {% endif %}
                </div>
                
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div id="checkResults" style="display: none;">
                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                    <div id="checkProgress" class="text-center py-5">
                        <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <h5>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏...</h5>
                        <p class="text-muted">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑</p>
                    </div>
                    
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                    <div id="checkResult" style="display: none;">
                        <!-- –£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã -->
                        <div class="card mb-4" id="threatCard">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-shield-alt fa-5x mb-3" id="threatIcon"></i>
                                <h2 id="threatTitle">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</h2>
                                <p class="lead mb-0" id="threatDescription"></p>
                                <div class="mt-3">
                                    <span class="badge badge-lg" id="threatBadge">SAFE</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confidence Score -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="mb-3">–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</h5>
                                <div class="progress" style="height: 40px;">
                                    <div class="progress-bar" 
                                         id="confidenceBar"
                                         role="progressbar" 
                                         style="width: 0%">
                                        <span id="confidenceText">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI –û–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
                        <div class="card mb-4" id="aiExplanationCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-robot"></i> AI –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
                                </h5>
                            </div>
                            <div class="card-body">
                                <p id="aiExplanation" class="mb-0"></p>
                            </div>
                        </div>
                        
                        <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle"></i> –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <strong>VirusTotal:</strong>
                                        <span id="vtScore" class="ms-2"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <strong>Google Safe Browsing:</strong>
                                        <span id="gsbStatus" class="ms-2"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <strong>URLhaus:</strong>
                                        <span id="urlhausStatus" class="ms-2"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <strong>SSL –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å:</strong>
                                        <span id="sslStatus" class="ms-2"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <strong>–í–æ–∑—Ä–∞—Å—Ç –¥–æ–º–µ–Ω–∞:</strong>
                                        <span id="domainAge" class="ms-2"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <strong>–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:</strong>
                                        <span id="shortUrl" class="ms-2"></span>
                                    </div>
                                </div>
                                
                                <!-- –ü—Ä–∏—á–∏–Ω—ã -->
                                <div id="reasonsContainer" class="mt-3" style="display: none;">
                                    <h6>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h6>
                                    <ul id="reasonsList"></ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aktionen -->
                        <div class="text-center">
                            <button class="btn btn-success" onclick="window.location.reload()">
                                <i class="fas fa-redo"></i> –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                            </button>
                            <a href="{{ url_for('dashboard.history_page') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="card bg-light mt-4">
                    <div class="card-body">
                        <h6><i class="fas fa-shield-alt"></i> –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:</h6>
                        <ul class="mb-2">
                            <li><strong>VirusTotal</strong> - –±–∞–∑–∞ –∏–∑ 70+ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤</li>
                            <li><strong>Google Safe Browsing</strong> - —Ñ–∏—à–∏–Ω–≥ –∏ malware</li>
                            <li><strong>URLhaus</strong> - –±–∞–∑–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö URL</li>
                            <li><strong>SSL –ø—Ä–æ–≤–µ—Ä–∫–∞</strong> - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</li>
                            <li><strong>WHOIS</strong> - –≤–æ–∑—Ä–∞—Å—Ç –¥–æ–º–µ–Ω–∞</li>
                        </ul>
                        <small class="text-muted">
                            ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 100% –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('checkForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const url = document.getElementById('urlInput').value;
    const checkBtn = document.getElementById('checkBtn');
    const resultsDiv = document.getElementById('checkResults');
    const progressDiv = document.getElementById('checkProgress');
    const resultDiv = document.getElementById('checkResult');
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    resultsDiv.style.display = 'block';
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    
    SecurityCheck.showButtonLoading(checkBtn, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
    
    try {
        const result = await SecurityCheckAPI.checkLink(url);
        
        // –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('üîç API Response:', result);
        console.log('   check object:', result.check);
        console.log('   threat_level:', result.check?.threat_level);
        console.log('   virustotal_score:', result.check?.virustotal_score);
        console.log('   ssl_valid:', result.check?.ssl_valid);
        
        // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success: true, check: {...}} - –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å data –∏–∑ check!
        displayResults(result.check);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        setTimeout(() => {
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';
        }, 500);
        
        SecurityCheck.showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        
    } catch (error) {
        SecurityCheck.showNotification('Fehler: ' + error.message, 'danger');
    } finally {
        SecurityCheck.hideButtonLoading(checkBtn);
    }
});

function displayResults(data) {
    const threatCard = document.getElementById('threatCard');
    const threatIcon = document.getElementById('threatIcon');
    const threatTitle = document.getElementById('threatTitle');
    const threatDescription = document.getElementById('threatDescription');
    const threatBadge = document.getElementById('threatBadge');
    
    // –£—Ä–æ–≤–µ–Ω—å —É–≥—Ä–æ–∑—ã
    if (data.threat_level === 'safe') {
        threatCard.className = 'card mb-4 border-success';
        threatIcon.className = 'fas fa-shield-alt fa-5x mb-3 text-success';
        threatTitle.textContent = '–ë–µ–∑–æ–ø–∞—Å–Ω–æ';
        threatDescription.textContent = '–°—Å—ã–ª–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤ –±–∞–∑–∞—Ö —É–≥—Ä–æ–∑';
        threatBadge.className = 'badge bg-success badge-lg';
        threatBadge.textContent = 'SAFE';
    } else if (data.threat_level === 'warning') {
        threatCard.className = 'card mb-4 border-warning';
        threatIcon.className = 'fas fa-exclamation-triangle fa-5x mb-3 text-warning';
        threatTitle.textContent = '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ';
        threatDescription.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏';
        threatBadge.className = 'badge bg-warning badge-lg';
        threatBadge.textContent = 'WARNING';
    } else {
        threatCard.className = 'card mb-4 border-danger';
        threatIcon.className = 'fas fa-times-circle fa-5x mb-3 text-danger';
        threatTitle.textContent = '–û–ø–∞—Å–Ω–æ!';
        threatDescription.textContent = '–°—Å—ã–ª–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–≥—Ä–æ–∑—É';
        threatBadge.className = 'badge bg-danger badge-lg';
        threatBadge.textContent = 'DANGER';
    }
    
    // Confidence score
    const confidence = data.confidence_score || 0;
    const confidenceBar = document.getElementById('confidenceBar');
    confidenceBar.style.width = confidence + '%';
    confidenceBar.className = 'progress-bar ' + 
        (confidence >= 80 ? 'bg-success' : confidence >= 60 ? 'bg-warning' : 'bg-danger');
    document.getElementById('confidenceText').textContent = confidence + '%';
    
    // AI –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    if (data.ai_explanation) {
        document.getElementById('aiExplanation').textContent = data.ai_explanation;
        document.getElementById('aiExplanationCard').style.display = 'block';
    }
    
    // –î–µ—Ç–∞–ª–∏
    const vtScore = data.virustotal_score;
    document.getElementById('vtScore').innerHTML = 
        vtScore !== null && vtScore !== undefined ? 
        `<span class="badge bg-${vtScore > 0 ? 'danger' : 'success'}">${vtScore} –¥–µ—Ç–µ–∫—Ü–∏–π</span>` :
        '<span class="text-muted">undefined</span>';
    
    document.getElementById('gsbStatus').innerHTML = 
        data.safe_browsing_threats && data.safe_browsing_threats.length > 0 ?
        `<span class="badge bg-danger">${data.safe_browsing_threats.join(', ')}</span>` :
        '<span class="badge bg-success">–ß–∏—Å—Ç–æ</span>';
    
    document.getElementById('urlhausStatus').innerHTML = 
        data.urlhaus_status === 'online' ?
        '<span class="badge bg-danger">–í –±–∞–∑–µ —É–≥—Ä–æ–∑</span>' :
        '<span class="badge bg-success">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>';
    
    const sslStatus = document.getElementById('sslStatus');
    if (data.ssl_valid === null || data.ssl_valid === undefined) {
        sslStatus.innerHTML = '<span class="badge bg-secondary">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>';
    } else if (data.ssl_valid === true) {
        sslStatus.innerHTML = '<span class="badge bg-success">–í–∞–ª–∏–¥–Ω—ã–π</span>';
    } else {
        sslStatus.innerHTML = '<span class="badge bg-danger">–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π</span>';
    }
    
    document.getElementById('domainAge').textContent = data.domain_age || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    document.getElementById('shortUrl').innerHTML = 
        data.is_shortened ? '<span class="badge bg-warning">–î–∞</span>' : '<span class="badge bg-secondary">–ù–µ—Ç</span>';
    
    // –ü—Ä–∏—á–∏–Ω—ã
    if (data.reasons && data.reasons.length > 0) {
        const reasonsList = document.getElementById('reasonsList');
        reasonsList.innerHTML = '';
        data.reasons.forEach(reason => {
            reasonsList.innerHTML += `<li>${reason}</li>`;
        });
        document.getElementById('reasonsContainer').style.display = 'block';
    }
}
</script>
{% endblock %}
