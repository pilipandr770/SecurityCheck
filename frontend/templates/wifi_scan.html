{% extends "base.html" %}

{% block title %}WiFi-Netzwerk-Scanner{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-wifi"></i> WiFi-Netzwerk-Scanner</h2>
            <p class="text-muted">Finden Sie alle Geräte, die mit Ihrem WiFi-Netzwerk verbunden sind</p>
        </div>
    </div>

    <!-- Formular -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-wifi fa-4x text-warning"></i>
                        <h4 class="mt-3">Lokales Netzwerk scannen</h4>
                        <p class="text-muted">Alle mit Ihrem Router verbundenen Geräte werden gefunden</p>
                    </div>

                    {% if not can_scan %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> {{ limit_message }}
                    </div>
                    {% endif %}

                    <div class="d-grid">
                        <button 
                            type="button" 
                            class="btn btn-warning btn-lg" 
                            id="startScanBtn"
                            {% if not can_scan %}disabled{% endif %}>
                            <i class="fas fa-play"></i> Scan starten
                        </button>
                    </div>

                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            Heute verfügbar: 
                            <strong>{{ limits.network_scans_remaining }}/{{ limits.network_scans_total }}</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fortschritt -->
    <div class="row mt-4" id="progressSection" style="display: none;">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5><i class="fas fa-spinner fa-spin"></i> Scannen...</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="progressBar" 
                             style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    <p class="text-muted mt-2 mb-0">
                        <small>Geräte im Netzwerk prüfen... Dies kann 1-2 Minuten dauern</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ergebnisse -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle"></i> Scan-Ergebnisse
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Allgemeine Informationen -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-network-wired fa-3x text-primary mb-2"></i>
                                <h6>Ihr Netzwerk</h6>
                                <strong id="networkInfo">-</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-laptop fa-3x text-info mb-2"></i>
                                <h6>Ihre IP</h6>
                                <strong id="yourIP">-</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-devices fa-3x text-warning mb-2"></i>
                                <h6>Geräte gesamt</h6>
                                <strong id="totalDevices">0</strong>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Geräteliste -->
                    <h5 class="mb-3"><i class="fas fa-list"></i> Verbundene Geräte</h5>
                    <div id="devicesList"></div>

                    <!-- KI-Erklärung -->
                    <div class="mt-4" id="aiExplanation" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-robot"></i> Sicherheitsanalyse</h6>
                            <p id="aiExplanationText"></p>
                        </div>
                    </div>

                    <!-- Empfehlungen -->
                    <div class="mt-2" id="aiRecommendation" style="display: none;">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-lightbulb"></i> Empfehlungen</h6>
                            <div id="aiRecommendationText"></div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-warning" id="newScanBtn">
                            <i class="fas fa-redo"></i> Neuer Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Verlauf -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Scan-Verlauf</h5>
                </div>
                <div class="card-body">
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const WiFiScanAPI = {
    async startScan() {
        const response = await fetch('/api/wifi-scans/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        return await response.json();
    },
    
    async getStatus(scanId) {
        const response = await fetch(`/api/wifi-scans/${scanId}/status`);
        return await response.json();
    },
    
    async getResults(scanId) {
        const response = await fetch(`/api/wifi-scans/${scanId}`);
        return await response.json();
    },
    
    async getHistory() {
        const response = await fetch('/api/wifi-scans/history');
        return await response.json();
    }
};

let currentScanId = null;
let statusCheckInterval = null;

document.getElementById('startScanBtn').addEventListener('click', async () => {
    try {
        const result = await WiFiScanAPI.startScan();
        
        if (!result.success) {
            alert(result.error);
            return;
        }
        
        currentScanId = result.scan_id;
        
        // Fortschritt anzeigen
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('startScanBtn').disabled = true;
        
        // Status alle 2 Sekunden prüfen
        statusCheckInterval = setInterval(checkStatus, 2000);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Starten des Scans');
    }
});

async function checkStatus() {
    if (!currentScanId) return;
    
    try {
        const status = await WiFiScanAPI.getStatus(currentScanId);
        
        if (status.success) {
            const progress = status.progress || 0;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            
            if (status.status === 'completed') {
                clearInterval(statusCheckInterval);
                await showResults();
            } else if (status.status === 'failed') {
                clearInterval(statusCheckInterval);
                alert('Scan-Fehler');
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('startScanBtn').disabled = false;
            }
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

async function showResults() {
    try {
        const result = await WiFiScanAPI.getResults(currentScanId);
        
        if (!result.success) {
            alert('Fehler beim Abrufen der Ergebnisse');
            return;
        }
        
        const scan = result.scan;
        
        // Allgemeine Informationen
        const networkInfo = document.getElementById('networkInfo');
        const yourIP = document.getElementById('yourIP');
        const totalDevices = document.getElementById('totalDevices');
        
        if (networkInfo) {
            networkInfo.textContent = (scan.services_detected && scan.services_detected.network) || 'N/A';
        }
        if (yourIP) {
            yourIP.textContent = scan.resolved_ip || 'N/A';
        }
        if (totalDevices) {
            totalDevices.textContent = scan.total_ports_scanned || 0;
        }
        
        // Geräteliste
        const devicesList = document.getElementById('devicesList');
        devicesList.innerHTML = '';
        
        if (scan.open_ports && scan.open_ports.length > 0) {
            scan.open_ports.forEach((device, index) => {
                const deviceCard = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-1 text-center">
                                    <i class="fas ${device.icon} fa-2x text-primary"></i>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="mb-0">${device.device_type}</h6>
                                    <small class="text-muted">${device.vendor}</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>IP:</strong> ${device.ip}<br>
                                    <strong>MAC:</strong> ${device.mac}
                                </div>
                                <div class="col-md-3">
                                    <strong>Hostname:</strong> ${device.hostname}
                                </div>
                                <div class="col-md-2 text-end">
                                    ${device.open_ports && device.open_ports.length > 0 ? 
                                        `<span class="badge bg-info">${device.open_ports.length} Ports</span>` : 
                                        '<span class="badge bg-secondary">Geschlossen</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                devicesList.innerHTML += deviceCard;
            });
        } else {
            devicesList.innerHTML = '<p class="text-muted">Keine Geräte gefunden</p>';
        }
        
        // KI-Analyse
        const aiExplanationText = document.getElementById('aiExplanationText');
        const aiExplanation = document.getElementById('aiExplanation');
        const aiRecommendationText = document.getElementById('aiRecommendationText');
        const aiRecommendation = document.getElementById('aiRecommendation');
        
        if (scan.ai_explanation && aiExplanationText && aiExplanation) {
            aiExplanationText.textContent = scan.ai_explanation;
            aiExplanation.style.display = 'block';
        }
        
        if (scan.ai_recommendation && aiRecommendationText && aiRecommendation) {
            aiRecommendationText.innerHTML = scan.ai_recommendation.replace(/\n/g, '<br>');
            aiRecommendation.style.display = 'block';
        }
        
        // Ergebnisse anzeigen
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('startScanBtn').disabled = false;
        
        // Historie aktualisieren
        loadHistory();
        
    } catch (error) {
        console.error('Error showing results:', error);
        alert('Fehler bei der Anzeige der Ergebnisse');
    }
}

document.getElementById('newScanBtn').addEventListener('click', () => {
    document.getElementById('resultsSection').style.display = 'none';
    window.scrollTo({top: 0, behavior: 'smooth'});
});

async function loadHistory() {
    try {
        const result = await WiFiScanAPI.getHistory();
        
        if (!result.success || !result.scans || result.scans.length === 0) {
            document.getElementById('historyList').innerHTML = '<p class="text-muted">Historie ist leer</p>';
            return;
        }
        
        let html = '<div class="list-group">';
        result.scans.forEach(scan => {
            const date = new Date(scan.created_at).toLocaleString('de-DE');
            const statusBadge = scan.status === 'completed' ? 
                '<span class="badge bg-success">Abgeschlossen</span>' : 
                '<span class="badge bg-warning">In Bearbeitung</span>';
            
            html += `
                <a href="#" class="list-group-item list-group-item-action" onclick="viewScan(${scan.id}); return false;">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Scan #${scan.id}</h6>
                        ${statusBadge}
                    </div>
                    <p class="mb-1"><small>
                        <i class="far fa-clock"></i> ${date} • 
                        <i class="fas fa-devices"></i> ${scan.total_ports_scanned || 0} Geräte
                    </small></p>
                </a>
            `;
        });
        html += '</div>';
        
        document.getElementById('historyList').innerHTML = html;
        
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

async function viewScan(scanId) {
    currentScanId = scanId;
    await showResults();
    window.scrollTo({top: document.getElementById('resultsSection').offsetTop - 100, behavior: 'smooth'});
}

// Загружаем историю при загрузке страницы
loadHistory();
</script>
{% endblock %}
